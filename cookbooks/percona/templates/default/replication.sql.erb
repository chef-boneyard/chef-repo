# Generated by Chef for <%= node["fqdn"] %>.
# Local modifications will be overwritten.

<% if node["percona"]["server"]["role"] == "master" %>
# Grant replication for a slave user.
GRANT REPLICATION SLAVE ON *.*
  TO '<%= node["percona"]["server"]["replication"]["username"] %>'@'%'
  IDENTIFIED BY '<%= @replication_password %>';

FLUSH PRIVILEGES;

# Ensure this is not running as a slave, usefule for master promotion
STOP SLAVE;
RESET SLAVE;
<% end -%>

<% if node["percona"]["server"]["role"] == "slave" %>
# Set replication parameters
CHANGE MASTER TO
  MASTER_HOST='<%= node["percona"]["server"]["replication"]["host"] %>',
  MASTER_PORT=<%= node["percona"]["server"]["replication"]["port"] %>,
  MASTER_USER='<%= node["percona"]["server"]["replication"]["username"] %>',
  MASTER_PASSWORD='<%= @replication_password %>';
# Start slave automatically
START SLAVE;
<% end -%>
